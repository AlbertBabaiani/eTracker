<div class="calendar-container">
  <app-calendar-controls
    [label]="currentLabel()"
    [currentView]="view()"
    (navigate)="navigate($event)"
    (viewChange)="view.set($event)"
    (today)="goToToday()"
  />

  <!-- 2. Year View Grid -->
  @if (view() === 'year') {
  <app-year-grid
    [currentDate]="currentDate()"
    [selectedDate]="selectedDate()"
    (monthSelection)="monthSelection($event)"
  />
  }

  <!-- 3. Day (Timeline) View -->
  @else if (view() === 'day') {
  <div class="day-timeline-container">
    <div class="time-labels">
      @for (hour of hours; track hour) {
      <div class="time-label">
        <span>{{ formatHour(hour) }}</span>
      </div>
      }
    </div>

    <div class="timeline-grid">
      @for (hour of hours; track hour) {
      <div class="grid-line"></div>
      }
      <!--  -->
      @for (slot of getCurrentDayReservations(); track slot.reservation.id) {
      <div
        class="timeline-event"
        [style.top.%]="calculateTop(slot.reservation)"
        [style.height.%]="calculateHeight(slot.reservation)"
      >
        <div class="event-content">
          <div class="event-time">
            {{ slot.reservation.startDate | date : 'shortTime' }} -
            {{ slot.reservation.endDate | date : 'shortTime' }}
          </div>
          <div class="event-guest">
            <div class="avatar-circle">{{ getInitials(slot.reservation.guestId) }}</div>
            <span>{{ slot.reservation.guestId }}</span>
          </div>
          <div class="event-status">{{ slot.reservation.status | titlecase }}</div>
        </div>
      </div>
      } @if (isToday(currentDate())) {
      <div class="current-time-line" [style.top.%]="calculateCurrentTimeTop()"></div>
      }
    </div>
  </div>
  }

  <!-- 4. Month / Week Grid -->
  @else {
  <div class="days-header" [class.hide-header]="view() === 'day'">
    @for (day of weekDays; track day) {
    <div class="day-name">{{ day }}</div>
    }
  </div>

  <div class="calendar-grid" [class]="view()">
    @for (day of calendarDays(); track $index) {
    <div
      class="day-cell"
      [class.empty]="!day.date"
      [class.today]="day.isToday"
      [class.past]="day.isPast"
      (click)="onDayClick(day)"
    >
      @if (day.date) {
      <div class="cell-header">
        <span class="day-number">{{ day.dayNumber }}</span>
        @if (view() === 'day') {
        <span class="day-weekday">{{ day.date | date : 'EEEE' }}</span>
        }
      </div>

      <div class="reservations-stack">
        @for (slot of day.slots; track slot.reservation.id) {
        <div
          class="guest-chip"
          [class.chip-start]="slot.type === 'start'"
          [class.chip-end]="slot.type === 'end'"
          [class.chip-stay]="slot.type === 'stay'"
        >
          <div class="avatar-mini">{{ getInitials(slot.reservation.guestId) }}</div>
          <div class="chip-content">
            <span class="guest-name">{{ slot.reservation.guestId }}</span>
            @if (slot.timeLabel) {
            <span class="chip-time">{{ slot.timeLabel }}</span>
            }
          </div>

          @if (slot.type === 'start') { <mat-icon class="tiny-icon">login</mat-icon> } @if
          (slot.type === 'end') { <mat-icon class="tiny-icon">logout</mat-icon> }
        </div>
        }
      </div>
      }
    </div>
    }
  </div>
  }

  <!-- 5. Bottom Panel: Properties List -->
  <footer class="properties-panel">
    <span class="panel-label">Filter by:</span>
    <div class="prop-list">
      <button
        class="prop-chip"
        [class.active]="selectedPropertyId() === null"
        (click)="toggleProperty(null)"
      >
        All
      </button>
      @for (prop of properties(); track prop.id) {
      <button
        class="prop-chip"
        [class.active]="selectedPropertyId() === prop.id"
        (click)="toggleProperty(prop.id)"
      >
        <mat-icon class="prop-icon">home</mat-icon>
        {{ prop.alias || prop.name }}
      </button>
      }
    </div>
  </footer>
</div>
