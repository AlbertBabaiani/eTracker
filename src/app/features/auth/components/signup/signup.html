<div class="shell auth-container" *transloco="let s; prefix: 'AUTH.SIGNUP'">
  <mat-card class="auth-card">
    <div class="language-container">
      <app-language-switcher />
    </div>

    <!-- Success State: Verification Email Sent -->
    @if (emailSent()) {
    <div class="success-state center-header">
      <mat-icon class="large-icon">mark_email_read</mat-icon>
      <h1 class="title">{{ s('VERIFICATION_SENT.TITLE') }}</h1>
      <p>{{ s('VERIFICATION_SENT.MESSAGE', { email: sentEmailAddress() }) }}</p>
      <button mat-flat-button color="primary" routerLink="/login" class="submit-btn">
        {{ s('VERIFICATION_SENT.GO_TO_LOGIN') }}
      </button>
    </div>
    }

    <!-- Sign Up Form -->
    @else {
    <mat-card-header class="center-header">
      <div class="brand-logo">
        <app-logo [logoLg]="true" [vertical]="true" />
      </div>
      <h1 class="title">{{ s('TITLE') }}</h1>
    </mat-card-header>

    <mat-card-content *transloco="let f; prefix: 'AUTH.FORM'">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <mat-stepper [linear]="true" #stepper>
          <!-- STEP 1: Personal Information -->
          <mat-step [stepControl]="personalGroup" formGroupName="personal">
            <ng-template matStepLabel>{{ s('STEPS.PERSONAL') }}</ng-template>

            <div class="step-content">
              <!-- First Name -->
              <mat-form-field appearance="outline" [hideRequiredMarker]="true" class="full-width">
                <mat-label>{{ f('FIRST_NAME.LABEL') }}</mat-label>
                <input
                  matInput
                  formControlName="firstName"
                  [placeholder]="f('FIRST_NAME.PLACEHOLDER')"
                />
                <mat-error>
                  @if (personalGroup.get('firstName')?.hasError('required')) {
                  {{ f('FIRST_NAME.ERROR.REQUIRED') }}
                  } @else if (personalGroup.get('firstName')?.hasError('minlength')) {
                  {{ f('FIRST_NAME.ERROR.MIN_LENGTH', { length: personalGroup.get('firstName')?.errors?.['minlength']?.requiredLength  }) }}
                  } @else if (personalGroup.get('firstName')?.hasError('maxlength')) {
                  {{ f('FIRST_NAME.ERROR.MAX_LENGTH', { length: personalGroup.get('firstName')?.errors?.['maxlength']?.requiredLength  }) }}
                  }
                </mat-error>
              </mat-form-field>

              <!-- Last Name -->
              <mat-form-field appearance="outline" [hideRequiredMarker]="true" class="full-width">
                <mat-label>{{ f('LAST_NAME.LABEL') }}</mat-label>
                <input
                  matInput
                  formControlName="lastName"
                  [placeholder]="f('LAST_NAME.PLACEHOLDER')"
                />
                <mat-error>
                  @if (personalGroup.get('lastName')?.hasError('required')) {
                  {{ f('LAST_NAME.ERROR.REQUIRED') }}
                  } @else if (personalGroup.get('lastName')?.hasError('minlength')) {
                  {{ f('LAST_NAME.ERROR.MIN_LENGTH', { length: personalGroup.get('lastName')?.errors?.['minlength']?.requiredLength  }) }}
                  } @else if (personalGroup.get('lastName')?.hasError('maxlength')) {
                  {{ f('LAST_NAME.ERROR.MAX_LENGTH', { length: personalGroup.get('lastName')?.errors?.['maxlength']?.requiredLength  }) }}
                  }
                </mat-error>
              </mat-form-field>

              <!-- Phone Number (+995) -->
              <mat-form-field appearance="outline" [hideRequiredMarker]="true" class="full-width">
                <mat-label>{{ f('PHONE.LABEL') }}</mat-label>
                <span matTextPrefix>+995 &nbsp;</span>
                <input matInput type="tel" formControlName="phone" placeholder="555000000" />

                <mat-error>
                  @if (personalGroup.get('phone')?.hasError('required')) {
                  {{ f('PHONE.ERROR.REQUIRED') }}
                  } @else if (personalGroup.get('phone')?.hasError('pattern')) {
                  {{ f('PHONE.ERROR.PATTERN', { length: personalGroup.get('phone')?.errors?.['pattern']?.requiredLength  }) }}
                  }
                </mat-error>
              </mat-form-field>

              <div class="step-actions">
                <button
                  mat-flat-button
                  [disabled]="personalGroup.invalid"
                  color="primary"
                  matStepperNext
                  type="button"
                >
                  Next
                </button>
              </div>
            </div>
          </mat-step>

          <!-- STEP 2: Account Details -->
          <mat-step [stepControl]="accountGroup" formGroupName="account">
            <ng-template matStepLabel>{{ s('STEPS.ACCOUNT') }}</ng-template>

            <div class="step-content">
              <!-- Email -->
              <mat-form-field appearance="outline" [hideRequiredMarker]="true" class="full-width">
                <mat-label>{{ f('EMAIL.LABEL') }}</mat-label>
                <input
                  matInput
                  formControlName="email"
                  type="email"
                  placeholder="example@mail.com"
                />
                <mat-error>
                  @if (accountGroup.get('email')?.hasError('required')) {
                  {{ f('EMAIL.ERROR.REQUIRED') }}
                  } @else if (accountGroup.get('email')?.hasError('email')) {
                  {{ f('EMAIL.ERROR.INVALID', { length: accountGroup.get('email')?.errors?.['invalid']?.requiredLength  }) }}
                  } @else if (accountGroup.get('email')?.hasError('maxlength')) {
                  {{ f('EMAIL.ERROR.MAX_LENGTH', { length: accountGroup.get('email')?.errors?.['maxlength']?.requiredLength  }) }}
                  }
                </mat-error>
              </mat-form-field>

              <!-- Password -->
              <mat-form-field appearance="outline" [hideRequiredMarker]="true" class="full-width">
                <mat-label>{{ f('PASSWORD.LABEL') }}</mat-label>
                <input
                  matInput
                  formControlName="password"
                  [type]="hidePassword() ? 'password' : 'text'"
                />
                <mat-hint>{{ f('PASSWORD.HINT') }}</mat-hint>
                <mat-error>
                  @if (accountGroup.get('password')?.hasError('required')) {
                  {{ f('PASSWORD.ERROR.REQUIRED') }}
                  } @else if (accountGroup.get('password')?.hasError('minlength')) {
                  {{ f('PASSWORD.ERROR.MIN_LENGTH', { length: accountGroup.get('password')?.errors?.['minlength']?.requiredLength  }) }}
                  } @else if (accountGroup.get('password')?.hasError('maxlength')) {
                  {{ f('PASSWORD.ERROR.MAX_LENGTH', { length: accountGroup.get('password')?.errors?.['maxlength']?.requiredLength  }) }}
                  } @else if (accountGroup.get('password')?.hasError('pattern')) {
                  {{ f('PASSWORD.ERROR.PATTERN') }}
                  }
                </mat-error>
              </mat-form-field>

              <!-- Repeat Password -->
              <mat-form-field appearance="outline" [hideRequiredMarker]="true" class="full-width">
                <mat-label>{{ f('REPEAT_PASSWORD.LABEL') }}</mat-label>
                <input
                  matInput
                  formControlName="repeatPassword"
                  [type]="hidePassword() ? 'password' : 'text'"
                />
                <mat-error>
                  @if (accountGroup.get('repeatPassword')?.hasError('required')) {
                  {{ f('PASSWORD.ERROR.REQUIRED') }}
                  } @else if(accountGroup.get('repeatPassword')?.hasError('mismatch')){
                  {{ f('REPEAT_PASSWORD.ERROR.MISMATCH') }}
                  }
                </mat-error>
              </mat-form-field>

              <!-- Show Password Checkbox -->
              <div class="checkbox-container">
                <mat-checkbox
                  [checked]="!hidePassword()"
                  (change)="hidePassword.set(!$event.checked)"
                  color="primary"
                >
                  {{ f('PASSWORD.Show') }}
                </mat-checkbox>
              </div>

              <div class="step-actions">
                <button mat-button matStepperPrevious type="button">Back</button>
                <button mat-flat-button color="primary" matStepperNext type="button">Next</button>
              </div>
            </div>
          </mat-step>

          <!-- STEP 3: Confirm Email / Finalize -->
          <mat-step>
            <ng-template matStepLabel>{{ s('STEPS.CONFIRM') }}</ng-template>

            <div class="step-content confirm-step">
              <mat-icon class="email-icon">mark_email_unread</mat-icon>

              <p>{{ s('CONFIRM_TEXT') }}</p>

              <h3 class="confirm-email-display">
                {{ accountGroup.get('email')?.value }}
              </h3>

              <div class="step-actions">
                <button mat-button matStepperPrevious type="button">Back</button>
                <button
                  class="submit-btn"
                  mat-flat-button
                  color="primary"
                  type="submit"
                  [disabled]="form.invalid"
                >
                  {{ s('BUTTON') }}
                </button>
              </div>
            </div>
          </mat-step>
        </mat-stepper>
      </form>
    </mat-card-content>

    <mat-card-footer class="auth-footer">
      <p>
        {{ s('HAVE_ACCOUNT') }} <a routerLink="/signin">{{ s('LOGIN') }}</a>
      </p>
    </mat-card-footer>
    }
  </mat-card>
</div>
